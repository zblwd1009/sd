-- åŠ›é‡ä¼ å¥‡è„šæœ¬
-- ä½œè€…: åŠ›é‡ä¼ å¥‡ä¸€åªç‰›ğŸ‚
-- ç‰ˆæœ¬: 1.0

-- æœåŠ¡å¼•ç”¨
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

-- åˆ›å»ºè¿œç¨‹äº‹ä»¶
local PowerEvents = Instance.new("Folder")
PowerEvents.Name = "PowerEvents"
PowerEvents.Parent = ReplicatedStorage

local AddPowerEvent = Instance.new("RemoteEvent")
AddPowerEvent.Name = "AddPower"
AddPowerEvent.Parent = PowerEvents

local UsePowerEvent = Instance.new("RemoteEvent")
UsePowerEvent.Name = "UsePower"
UsePowerEvent.Parent = PowerEvents

-- ç©å®¶æ•°æ®æ¨¡å—
local PlayerData = {}
local function setupPlayerData(player)
    PlayerData[player] = {
        Strength = 1,    -- åŠ›é‡
        Speed = 1,       -- é€Ÿåº¦
        Energy = 1,      -- èƒ½é‡
        Level = 1,      -- ç­‰çº§
        XP = 0,         -- ç»éªŒå€¼
        PowerPoints = 0, -- å¯åˆ†é…ç‚¹æ•°
        Powers = {}      -- å·²è§£é”èƒ½åŠ›
    }
end

-- åˆå§‹åŒ–ç©å®¶
Players.PlayerAdded:Connect(function(player)
    setupPlayerData(player)
    
    -- åˆ›å»ºç©å®¶GUI
    local leaderstats = Instance.new("Folder")
    leaderstats.Name = "leaderstats"
    leaderstats.Parent = player
    
    local level = Instance.new("IntValue")
    level.Name = "Level"
    level.Value = 1
    level.Parent = leaderstats
    
    -- å‘é€åˆå§‹æ•°æ®ç»™å®¢æˆ·ç«¯
    player:WaitForChild("PlayerGui")
    local dataToSend = PlayerData[player]
    AddPowerEvent:FireClient(player, dataToSend)
end)

Players.PlayerRemoving:Connect(function(player)
    PlayerData[player] = nil
end)

-- å‡çº§ç³»ç»Ÿ
local function calculateXPToNextLevel(currentLevel)
    return currentLevel * 100
end

local function levelUp(player)
    local data = PlayerData[player]
    data.Level += 1
    data.PowerPoints += 3  -- æ¯å‡ä¸€çº§è·å¾—3ä¸ªç‚¹æ•°
    player.leaderstats.Level.Value = data.Level
    
    -- é€šçŸ¥å®¢æˆ·ç«¯
    AddPowerEvent:FireClient(player, data)
end

local function addXP(player, amount)
    local data = PlayerData[player]
    data.XP += amount
    
    local xpNeeded = calculateXPToNextLevel(data.Level)
    if data.XP >= xpNeeded then
        data.XP -= xpNeeded
        levelUp(player)
    end
end

-- åŠ›é‡ç³»ç»Ÿ
local function addPower(player, powerType)
    local data = PlayerData[player]
    if data.PowerPoints <= 0 then return end
    
    if powerType == "Strength" then
        data.Strength += 1
    elseif powerType == "Speed" then
        data.Speed += 1
    elseif powerType == "Energy" then
        data.Energy += 1
    end
    
    data.PowerPoints -= 1
    AddPowerEvent:FireClient(player, data)
end

-- èƒ½åŠ›ä½¿ç”¨ç³»ç»Ÿ
local powers = {
    SuperPunch = {
        Name = "Super Punch",
        Description = "A powerful punch that deals extra damage",
        Cost = 10,
        Cooldown = 5,
        Execute = function(player, target)
            local humanoid = target:FindFirstChildOfClass("Humanoid")
            if humanoid then
                local damage = PlayerData[player].Strength * 10
                humanoid:TakeDamage(damage)
            end
        end
    },
    SpeedDash = {
        Name = "Speed Dash",
        Description = "Quickly dash forward",
        Cost = 5,
        Cooldown = 3,
        Execute = function(player)
            local character = player.Character
            if character then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    -- å®ç°å†²åˆºé€»è¾‘
                end
            end
        end
    },
    EnergyShield = {
        Name = "Energy Shield",
        Description = "Create a protective shield around you",
        Cost = 15,
        Cooldown = 10,
        Execute = function(player)
            -- å®ç°æŠ¤ç›¾é€»è¾‘
        end
    }
}

local cooldowns = {}
local function usePower(player, powerName, target)
    local power = powers[powerName]
    if not power then return end
    
    local data = PlayerData[player]
    if not data then return end
    
    -- æ£€æŸ¥å†·å´
    if cooldowns[player] and cooldowns[player][powerName] then
        if os.time() - cooldowns[player][powerName] < power.Cooldown then
            return
        end
    end
    
    -- æ‰§è¡Œèƒ½åŠ›
    power.Execute(player, target)
    
    -- è®¾ç½®å†·å´
    if not cooldowns[player] then
        cooldowns[player] = {}
    end
    cooldowns[player][powerName] = os.time()
end

-- è¿œç¨‹äº‹ä»¶å¤„ç†
AddPowerEvent.OnServerEvent:Connect(function(player, powerType)
    addPower(player, powerType)
end)

UsePowerEvent.OnServerEvent:Connect(function(player, powerName, target)
    usePower(player, powerName, target)
end)

-- æˆ˜æ–—ç³»ç»Ÿç¤ºä¾‹
local function onCharacterDamage(victim, damage, attacker)
    if attacker and Players:GetPlayerFromCharacter(attacker) then
        local player = Players:GetPlayerFromCharacter(attacker)
        addXP(player, damage)  -- æ ¹æ®é€ æˆçš„ä¼¤å®³è·å¾—ç»éªŒ
    end
end

-- è¿æ¥ä¼¤å®³äº‹ä»¶
game:GetService("Players").PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        local humanoid = character:WaitForChild("Humanoid")
        humanoid.Died:Connect(function()
            -- è§’è‰²æ­»äº¡é€»è¾‘
        end)
    end)
end)

-- ç¤ºä¾‹NPCç”Ÿæˆ
local function spawnTrainingDummy(position)
    local dummy = Instance.new("Model")
    dummy.Name = "TrainingDummy"
    
    local humanoid = Instance.new("Humanoid")
    humanoid.MaxHealth = 100
    humanoid.Health = 100
    humanoid.Parent = dummy
    
    local head = Instance.new("Part")
    head.Name = "Head"
    head.Size = Vector3.new(2, 2, 2)
    head.Position = position
    head.Anchored = false
    head.Parent = dummy
    
    -- å…¶ä»–èº«ä½“éƒ¨ä½...
    
    dummy.PrimaryPart = head
    dummy.Parent = workspace
    
    -- è¿æ¥ä¼¤å®³äº‹ä»¶
    humanoid.Died:Connect(function()
        wait(5)
        humanoid.Health = humanoid.MaxHealth
    end)
    
    return dummy
end

-- ç”Ÿæˆä¸€äº›è®­ç»ƒå‡äºº
spawnTrainingDummy(Vector3.new(0, 5, 0))
spawnTrainingDummy(Vector3.new(5, 5, 5))
spawnTrainingDummy(Vector3.new(-5, 5, 5))